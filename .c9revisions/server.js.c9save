{"ts":1371697228677,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"module.exports.conf = require('./conf/conf');\nvar domain = require('domain'),\n    http = require('http'),\n    fs = require('fs'),\n    path = require('path'),\n    zlib = require('zlib');\nvar serverDm = domain.create();\nvar processPath = path.dirname(process.argv[1]);\nglobal.yRead = {}; // 注册全局变量yRead\nyRead.version = '0.0.1';\n\nserverDm.on('error', function (err) {\n    delete err.domain;\n    yRead.errlog.error(err);\n});\nserverDm.run(function() {\n    yRead.conf = module.exports.conf = require('./conf/conf'); // 注册rrestjs配置文件\n    yRead.module = {};\n    yRead.module.rrestjs = require('rrestjs');\n/*    yRead.module.marked = require('marked');\n    yRead.module.mongoskin = require('mongoskin');\n    yRead.module.nodemailer = require('nodemailer');*/\n    yRead.errlog = yRead.module.rrestjs.restlog;\n    yRead.lib = {};\n/*    yRead.lib.tools = require('./lib/tools.js');\n    yRead.lib.CacheLRU = require('./lib/cacheLRU.js');\n    yRead.lib.CacheTL = require('./lib/cacheTL.js');\n    yRead.lib.msg = require('./lib/msg.js');\n    yRead.lib.json = require('./lib/json.js');\n    yRead.lib.converter = require('./lib/anyBaseConverter.js');\n    yRead.lib.email = require('./lib/email.js');*/\n    yRead.dao = {};\n    yRead.cache = {};\n    yRead.api = {};\n\n    creatServer();\n});\n\nfunction creatServer() {\n    server = http.createServer(function(req, res) {\n        var dm = domain.create();\n        dm.on('error', function (err) {\n            console.log(err);\n            delete err.domain;\n            err.type = 'error';\n            try {\n                res.on('finish', function () {\n                    //yRead.dao.db.close();\n                    process.nextTick(function () {\n                        dm.dispose();\n                    });\n                });\n                if (err.hasOwnProperty('name')) {\n                    res.sendjson({\n                        err: err\n                    });\n                } else {\n                    //console.log('ReqErr:******************');\n                    console.log(req.session + ':' + req.method + ':' + req.path);\n                    yRead.errlog.error(err);\n                    res.sendjson({\n                        err: {\n                            name: '请求错误',\n                            message: '对不起，请求出错了！',\n                            type: 'error',\n                            url: '/'\n                        }\n                    });\n                }\n            } catch (err) {\n                delete err.domain;\n                //console.log('CatchERR:******************');\n                yRead.errlog.error(err);\n                dm.dispose();\n            }\n        });\n        dm.run(function () {\n            if (req.path[0] === 'api' && yRead.api[req.path[1]]) {\n                yRead.api[req.path[1]][req.method.toUpperCase()](req, res, dm);\n                if (req.path[1] === 'index') {\n                    yRead.api.index.updateOnlineCache(req);\n                }\n            } else {\n                res.setHeader(\"Content-Type\", \"text/html\");\n                if (yRead.indexTpl) {\n                    res.send(yRead.indexTpl);\n                } else {\n                    fs.readFile(processPath + '/web/index.html', 'utf8', serverDm.intercept(function (data) {\n                    //    yRead.indexTpl = data;\n                        res.send(data);\n                    }));\n                }\n            }\n        });\n    }).listen(yRead.module.rrestjs.config.listenPort);\n};"]],"start1":0,"start2":0,"length1":0,"length2":3461}]],"length":3461}
{"contributors":[],"silentsave":false,"ts":1371697247282,"patch":[[{"diffs":[[0,"   }"],[-1,"\n        });\n    }).listen("],[1,"//"],[0,"yRea"]],"start1":3387,"start2":3387,"length1":35,"length2":10},{"diffs":[[0,"stenPort"],[1,"\n        });//process.env.PORT\n    }).listen(process.env.PORT"],[0,");\n};"]],"start1":3423,"start2":3423,"length1":13,"length2":74}]],"length":3497,"saved":false}
{"contributors":[],"silentsave":false,"ts":1371705951362,"patch":[[{"diffs":[[0,"变量yRead\n"],[1,"var yRead = {};\n"],[0,"yRead.ve"]],"start1":293,"start2":293,"length1":16,"length2":32},{"diffs":[[0,") {\n    "],[1,"var "],[0,"server ="]],"start1":1309,"start2":1309,"length1":16,"length2":20}]],"length":3517,"saved":false}
{"ts":1371705969289,"patch":[[{"diffs":[[0,"\n   "],[-1," var server ="],[0," htt"]],"start1":1312,"start2":1312,"length1":21,"length2":8}]],"length":3504,"saved":false}
